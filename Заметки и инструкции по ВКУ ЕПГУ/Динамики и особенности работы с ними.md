Есть много примеров работы с динамическими элементами, такими как "Динамическое формирование выпадающего списка/квиза"
Про динамическое формирование выпадающего списка - тут зависит от степени извращения разработчика над заявителем (делать с возможностью поиска или нет)
Всё остаётся на вашей совести, меня сюда не впутывайте, я делюсь тем, что накопил дабы упростить вам жизнь (пожалейте себя, пожалуйста, вы итак попали в тяжёлую историю, которая активно развивается через наши страдания)
Как говорится: через тернии к звёздам, так и мы на госуслуги через костыли и страдания
![[Стартуем!.png]]
# Динамическое формирование квиза и особенности работы с ним
Есть вот такой шаблон у нас на ВКУ [Динамическое отображение кнопок в QuestionScr (квиз) 1.0.6](https://vku.test.gosuslugi.ru/template/2777/1.0.6)
Если он не доступен по ссылке выше, просто поменяйте версию либо поищите в шаблонах
Для того, чтобы сформировать список, необходимо определиться со следующими деталями:
* сколько будет кнопок
* какие будут условия для отображения тех или иных кнопок
* Какой будет порядок для генерации кнопок
Нам предлагают в шаблоне такой вариант смотреть и делать также (Потому что шаблон не всегда для тупого копирования и вставки в свои услуги, это шаблон, чтобы посмотреть и повторить интегрировать самим):
![[Шаблон динамического квиза.png]]
Содержимое описания:
```json
{
    "linkedValues": [
        {
            "argument": "kolvo",
            "jsonLogic": {
                "if": [
                    {
                        "==": [
                            "answer.sc2_2777.value",
                            2
                        ]
                    },
                    "[{\"title\":\"Кнопка 1\",\"code\":\"1\"},{\"title\":\"Кнопка 2\",\"code\":\"2\"}]",
                    {
                        "==": [
                            "answer.sc2_2777.value",
                            3
                        ]
                    },
                    "[{\"title\":\"Кнопка 1\",\"code\":\"1\"},{\"title\":\"Кнопка 2\",\"code\":\"2\"},{\"title\":\"Кнопка 3\",\"code\":\"3\"}]",
                    {
                        "==": [
                            "answer.sc2_2777.value",
                            4
                        ]
                    },
                    "[{\"title\":\"Кнопка 1\",\"code\":\"1\"},{\"title\":\"Кнопка 2\",\"code\":\"2\"},{\"title\":\"Кнопка 3\",\"code\":\"3\"},{\"title\":\"Кнопка 4\",\"code\":\"4\"}]",
                    {
                        "==": [
                            "answer.sc2_2777.value",
                            5
                        ]
                    },
                    "[{\"title\":\"Кнопка 1\",\"code\":\"1\"},{\"title\":\"Кнопка 2\",\"code\":\"2\"},{\"title\":\"Кнопка 3\",\"code\":\"3\"},{\"title\":\"Кнопка 4\",\"code\":\"4\"},{\"title\":\"Кнопка 5\",\"code\":\"5\"}]",
                    {
                        "==": [
                            "answer.sc2_2777.value",
                            6
                        ]
                    },
                    "[{\"title\":\"Кнопка 1\",\"code\":\"1\"},{\"title\":\"Кнопка 2\",\"code\":\"2\"},{\"title\":\"Кнопка 3\",\"code\":\"3\"},{\"title\":\"Кнопка 4\",\"code\":\"4\"},{\"title\":\"Кнопка 5\",\"code\":\"5\"},{\"title\":\"Кнопка 6\",\"code\":\"6\"}]"
                ]
            }
        }
    ]
}
```
Как видим из кода выше - минимум 2 кнопки заставят добавить, а как максимум - 6
Как надо будет описать простоту в обращении к квизу, который должен будет быть сформирован динамически:
![[Настройка квиза динамика по ответам.png]]
А вот что будет для подстановки вместо ${NAME} слов или текста
![[Подстановка текста в значения.png]]
Если втупую копипастить, то можно упустить важный нюанс - никто не запрещает прописать свои ссылки для подсказки, сохраняемого значения, и ваще любой другой текст. Почему title? Да потому что так прописано в калькуляторе формирования массива кнопок - отображаемое title, сохраняемое code!
```json
[{\"title\":\"Кнопка 1\",\"code\":\"1\"},{\"title\":\"Кнопка 2\",\"code\":\"2\"},{\"title\":\"Кнопка 3\",\"code\":\"3\"}]
```
Или если раскрыть кавычки, то вот такой текст получается в содержимом компонента:
```json
[
    {
        "title": "Кнопка 1",
        "code": "1"
    },
    {
        "title": "Кнопка 2",
        "code": "2"
    },
    {
        "title": "Кнопка 3",
        "code": "3"
    }
]
```
И в шаблоне, если смотреть дальше, есть лишний экран, который я также раньше в тупую копировал и обращался, но на мой взгляд - **излишне**:
![[После квиза вытянуть его значение излишне.png]]
Почему это излишне:
1) Квиз обычно в правилах идёт без атрибута, а тут указываем, что наш квиз динамический далеко не динамический, а хранит два атрибута - title и code
2) Лишний экран и сложнее правила будут для переходов
Теперь разберём на примерах и живых значениях, почему оно будет так:
Я решил ввести число 2, чтобы получить две кнопки, вот что я вижу в логах после посещения экранов:
![[Пошёл и создал 2 кнопки в динамике.png]]
И вот что я получил на выходе:
![[Динамика итоги.png]]
sc1_2777 - это наш квиз с выбранным ответом. У него 2 атрибута: title и code, посему правило будет сложнее обычного, надо указать атрибут у квиза
sc7_2777 - это то, что я щитаю лишним, оно тупо усложняет тогда правило перехода, но для демонстрации пойдёт

Из примера живой услуги, как будут отличаться правила переходов:
![[Правило перехода при динамическом квизе.png]]
Как видим, s72c1 в моём случае, это динамический квиз, у которого также есть атрибуты, поскольку формируется динамически (в моём случае либо показать 1 кнопку либо 3)
Обращает на себя внимание слово "Атрибут компонента", почему так? Смотрим скриншот выше, где я выделил цветом важное и лишнее
![[Обращение к излишнему при динамическом квизе.png]]
А вот так может выглядеть правило перехода, если мы будем ссылаться на тот же атрибут квиза, который мы получили, но пошли через калькулятор снова его получать (я щитаю, что избыточно, сложнее логика будет же + лишний экран)
Пускай не смущает разность правил и компонентов, к которым я обращаюсь, поскольку калькуляторы там огромные, а в некоторых случаях содержат не одно, а несколько аргументов калькуляторе

# Пример из живой услуги в проде
Мы делали динамический квиз с вот такими настройками
![[Полная настройка динамического квиза.png]]
Содержимое моего калькулятора для такого квиза:
```json
{
    "linkedValues": [
        {
            "argument": "changeSmiKviz",
            "jsonLogic": {
                "if": [
                    {
                        "==": [
                            "answer.s8c2.value.arguments.countSmi",
                            "manyToMany"
                        ]
                    },
                    "[{\"title\":\"Добавление и исключение СМИ\", \"description\": \"В том числе замена СМИ\", \"code\":\"3\"}, {\"title\":\"Добавление СМИ\", \"description\": \"\", \"code\":\"2\"}, {\"title\":\"Исключение СМИ\",\"description\":\"\", \"code\":\"1\"}]",
                    {
                        "and": [
                            {
                                "==": [
                                    "answer.s8c2.value.arguments.countSmi",
                                    "manyToOne"
                                ]
                            },
                            {
                                "==": [
                                    "answer.s169c1.value",
                                    "1"
                                ]
                            }
                        ]
                    },
                    "[{\"title\":\"Добавление и исключение СМИ\", \"description\": \"В том числе замена СМИ\", \"code\":\"3\"}, {\"title\":\"Исключение СМИ\",\"description\":\"\", \"code\":\"1\"}]",
                    "[{\"title\":\"Добавление и исключение СМИ\", \"description\": \"В том числе замена СМИ\", \"code\":\"3\"}, {\"title\":\"Добавление СМИ\", \"description\": \"\", \"code\":\"2\"}]"
                ]
            }
        }
    ]
}
```
Прошу обратить внимание, что у меня во всех калькуляторах есть после условий ещё одна строка - строка по умолчанию. Если она будет отсутствовать, то велик шанс получить ~~по жопе~~ ошибки, которые будут пздц критическими и придётся заново всю услугу проходить дабы сбросить её

>[!DANGER] Очень важно!
>Всегда добавляйте условие по умолчанию в любые свои калькуляторы, чтобы не сломалась услуга на экране, куда совершён переход!

# Динамическое формирование выпадающего списка

Теперь про выпадашки, в целом, для них всё гораздо проще, поскольку часто это справочники локальные, т.е. хранят ссылку на массив-источник значений, в котором будет отображаемое и сохраняемое значения
[Динамическое формирование выпадающего списка 1.0.3](https://vku.test.gosuslugi.ru/template/4431/1.0.3)
В шаблоне предлагается начать с квиза, в котором нужно выбрать, сколько будет сгенерировано значений для выпадающего списка (актуально для Lookup, DropDown, MultiChoiceDictionary)
![[Простенький квиз для динамики.png]]
Какой там заложен калькулятор:
![[Калькулятор для списка динамического.png]]
Его код:
```json
{
    "linkedValues": [
        {
            "argument": "kolvo",
            "jsonLogic": {
                "if": [
                    {
                        "==": [
                            "answer.sc1_4431.value",
                            1
                        ]
                    },
                    "[{\"title\":\"Значение 1\",\"code\":\"1\"}]",
                    {
                        "==": [
                            "answer.sc1_4431.value",
                            2
                        ]
                    },
                    "[{\"title\":\"Значение 1\",\"code\":\"1\"}, {\"title\":\"Значение 2\",\"code\":\"2\"}]",
                    {
                        "==": [
                            "answer.sc1_4431.value",
                            3
                        ]
                    },
                    "[{\"title\":\"Значение 1\",\"code\":\"1\"}, {\"title\":\"Значение 2\",\"code\":\"2\"}, {\"title\":\"Значение 3\",\"code\":\"13\"}]"
                ]
            }
        }
    ]
}
```
И опять же, ошибка будет, если ни в одно условие не попадёте
Теперь непосредственно сам справочник (в примере dropDown, удобно для небольшого количества значений)
![[Настройка компонента выпадающего списка.png]]
В целом, игнорируем всё, кроме заголовка справочника, нас интересует как они его формируют и получают для него значения, а они в разделе LinkedValues
Источник данных для мультика:
![[Источник для выпадающего списка в шаблоне динамика.png]]
Что показывать на экране:
![[Что показать на экранчике.png]]
Что передавать в сохраняемое значение:
![[Сохраняемое значение из шаблона мультика.png]]
И вот тут я начинаю яростно материться, т.к. нас жёстко тут кидают через прогиб!
Обратите внимание, на какой атрибут массива нас отправляют? На title!
Напоминаю, что у нас в источник передаётся массив следующего вида
```json
[
    {
        "title": "Кнопка 1",
        "code": "1"
    },
    {
        "title": "Кнопка 2",
        "code": "2"
    },
    {
        "title": "Кнопка 3",
        "code": "3"
    }
]
```
Т.е. title - отдельно, code - желаемое сохраняемое значение отдельно, а в шаблоне кидают, типа можно пренебречь code, один фиг не используется
Как оно должно быть корректно передаваться:
